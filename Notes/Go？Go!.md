# Go？Go!

> 最开始看到Go语言应该是B站源码泄露那次，当时想Go是个啥东西？没听说过，小语言吧。现在想想真的是有点坐井观天了。

# 什么是Go语言？

Go语言是谷歌2009发布的第二款开源编程语言，作为火爆好入职的编程语言，自面世以来，以高效的开发效率和完美的运行速度，迅速风靡全球，被誉为“**21世纪的C语言**”。

Go语言专门针对多处理器系统应用程序的编程进行了优化，可以在不损耗程序性能的前提下简化代码的复杂性，使用Go编译的程序不仅媲美C/C++代码的速度，而且更加安全、支持并行进程。

### 都有哪些公司在使用Go？

- **国内公司**
  - 阿里巴巴
  - 腾讯
  - 百度
  - 字节跳动
  - 小米
  - 京东
  - 360
  - 网易
  - 新浪
  - 爱奇艺
  - 哔哩哔哩等
- **国外公司**
  - Google
  - Facebook
  - AWS等

不止于上述的公司，在**Gopher China 2019**大会上滴滴公司作为主办方分享Go语言在大型微服务框架设计方面的实践，百度分享Go语言在春晚抢红包项目、自动驾驶、百度智能小程序、百度APP等方面的应用优势，知乎使用Go语言重构代码后节省超过80%的服务器资源。此外，腾讯也在积极向Go语言靠拢。

这么多的公司都青睐于使用Go来编程，看来Go是实火了。那么，有人就会问了，**Go语言能做什么？**

**Go语言的应用场景如下：**

- 服务端开发
- 爬虫及大数据
- 网络编程
- Paas云平台领域
- 分布式存储领域
- 区块链领域
- 容器虚拟化，如Docker，K8s。

### Go语言有哪些特性？

- 语法简洁，相比其他语言更容易上手，开发效率更高；
- 自带垃圾回收（GC），不用再手动申请释放内存，能够有效避免 Bug，提高性能；
- 语言层面的并发支持，让你很容易开发出高性能的程序；
- 提供的标准库强大，第三方库也足够丰富，可以拿来即用，提高开发效率；
- 可通过静态编译直接生成一个可执行文件，运行时不依赖其他库，部署方便，可伸缩能力强；
- 提供跨平台支持，很容易编译出跨各个系统平台直接运行的程序。

> 垃圾回收(CG,Garbage Collection)：早期的语言中是没有自动垃圾回收的。比如：C语言中就需要使用malloc/free来人为地申请或者释放堆内存。
>
> 一种可能是并发问题，并发执行的程序容易错误地释放掉还在使用的内存，一种可能是重复释放内存，还可能是直接忘记释放内存，从而导致内存泄露等问题。
>
> GC不回收栈中的内存，因为栈是一块专用内存，专门为了函数执行而准备的，存储着函数的局部变量以及调用栈。
>
> 比如局部变量就不能呗函数外访问，所以这块内存用完就可以直接释放，也正因为如此，栈中的数据可以通过简单的编译器指令自动清理，也就不需要通过GC来回收了。

### 那么，Go中的垃圾回收机制是什么？

当说道Go中的垃圾回收时，通常会提到三色标记法。

在三色标记法之前有一个算法叫**Mark-And-Sweep**（标记清扫），这个算法是严格按照追踪式算法的思路来实现的。追踪式算法会设置一个标记为来记录对象是否被使用。

最开始所有的标记为都是0，如果发现对象是可达的就会置为1，一步步下去就会呈现一个类似树状的结果。等标记的步骤完成后，会将未被标记的对象统一清理，再把所有的标记为设置成0方便下次清理。

标记清扫算法存在的最大问题是GC期间需要把整个程序完全暂停，不能异步进行GC操作。因为在不同阶段标记清扫法的标志位0和1有不同的含义，那么新增的对象无论标记为什么都有可能意外删除这个对象。对于一个实时性要求高的系统而言，这种需要长时间挂起的标记清扫发是不可接受的。所以就需要一个算法来解决GC运行时程序长时间挂起的问题，这就是三色标记法。

### 三色标记法

相比于传统的清扫算法，三色标记最大的优点在与异步执行，从而可以一种短时间极少的代价或者完全没有中断来执行整个GC。

三色标记法很简单，首先将对象用三种颜色（白色、灰色和黑色）表示。最开始所有对象都是白色的，然后把其中全局变量和函数栈里的对象都置为**<font color=grey>灰色</font>**。第二步把**<font color=grey>灰色</font>**的对象全部置为**黑色**，然后把原先**<font color=grey>灰色</font>**对象指向的变量都置为**<font color=grey>灰色</font>**，以此类推。等到发现没有对象可以被置为**灰色**的白色变量就一定是需要被清理的垃圾了。

![img](https://pic2.zhimg.com/v2-5fe8ea45e2518ca19cfeb31558160fb1_b.webp)

三色标记法因为多了一个白色的状态来存放不确定的对象，所以可以异步地执行。当然异步执行的代价是可能会造成一些遗漏，因为那些早先被标记为黑色的对象可能目前已经是不可达的了。所以三色标记法是一个 false negative（假阴性）的算法。

除了异步标记的优点，三色标记法掌握了更多当前内存的信息，因此可以更加精确地按需调度，而不用像标记清扫法那样只能定时执行。

## 本文参考

1. [Go 垃圾回收（三）——三色标记法是什么鬼？](https://zhuanlan.zhihu.com/p/105495961/)
2. 